#!/bin/zsh

cd "${0:A:h}"

# PROFILE="--profile"
# FIXED="yes"

# TEST="benchmarks/472-mips-pipelined/472-mips-fragment.v"
# TEST="benchmarks/472-mips-pipelined/rom32-test-1.v"
TEST="benchmarks/472-mips-pipelined/mips_pipeline.v"
# TEST="benchmarks/472-mips-pipelined/neg-mux3_test_02.v"
# TEST="benchmarks/crypto_cores/sha_core/trunk/rtl/sha256_stub_3.v"
# TEST="benchmarks/crypto_cores/tiny_aes/trunk/rtl/aes_256.v"
# TEST="benchmarks/fpu/verilog/fpu.v"
# TEST="benchmarks/xcrypto-ref/rtl/coprocessor/mult_test.v"
# TEST="benchmarks/xcrypto-ref/rtl/coprocessor/scarv_cop_palu.v"
# TEST="benchmarks/yarvi/shared/yarvi.v"
# TEST="examples/verilog/stall.v"
# TEST="test/verilog/neg/neg-test-2.v"
# TEST="test/verilog/pos/merge-02.v"
# TEST="test/verilog/pos/merge03.v"
# TEST="test/verilog/pos/nb-test-01.v"
# TEST="test/verilog/pos/submodule-02.v"
# TEST="test/verilog/pos/submodule-04.v"
# TEST="test/verilog/pos/tr-submodule-01.v"
# TEST="test/verilog/pos/tr-test-12.v"
# TEST="benchmarks/crypto_cores/tiny_aes/trunk/rtl/test6.v"

TEST_DIR="${TEST:h}"
TEST_NAME="${TEST:t:r}"
TEST_FILE="${TEST_DIR}/${TEST_NAME}.v"

if [ -z "${FIXED}" ]; then
        TEST_ANNOT="${TEST_DIR}/annot-${TEST_NAME}.json"
else
        TEST_ANNOT="${TEST_DIR}/annot-${TEST_NAME}_fixed.json"
fi

# TEST_ANNOT="benchmarks/crypto_cores/tiny_aes/trunk/rtl/annot-test6.json"
# nvim "${TEST_ANNOT}"; exit 0

./iodine --build ${PROFILE} && \
        ./iodine ${PROFILE} "${TEST_FILE}" "${TEST_ANNOT}" --verbose $@
